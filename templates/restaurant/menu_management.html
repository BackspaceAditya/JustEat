{% extends "base.html" %}

{% block title %}Menu Management - JustEat{% endblock %}

{% block content %}
<script type="application/json" id="restaurant-data">
    {% if restaurant %}
        {{ restaurant|tojson }}
    {% else %}
        null
    {% endif %}
</script>
<div class="container" style="padding: 2rem 0;">
    <div class="page-header mb-4">
        <h1>Menu Management</h1>
        <p class="text-secondary">Manage your restaurant menu items</p>
    </div>

    <!-- Restaurant Selection -->
    {% if restaurants|length > 1 %}
    <div class="restaurant-selector mb-4">
        <div class="form-group">
            <label for="restaurantSelect" class="form-label">Select Restaurant:</label>
            <select id="restaurantSelect" class="form-control" onchange="changeRestaurant()">
                <option value="">Choose a restaurant...</option>
                {% for rest in restaurants %}
                <option value="{{ rest.id }}" {% if restaurant and rest.id == restaurant.id %}selected{% endif %}>
                    {{ rest.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% endif %}

    {% if restaurant %}
    <!-- Restaurant Info -->
    <div class="restaurant-info mb-4">
        <div class="card">
            <div class="card-body">
                <h3>{{ restaurant.name }}</h3>
                <p class="text-secondary">{{ restaurant.cuisine_type }} â€¢ {{ restaurant.address }}</p>
            </div>
        </div>
    </div>

    <!-- Add New Item Button -->
    <div class="menu-actions mb-4">
        <button class="btn btn-primary" onclick="showAddItemModal()">
            <i class="fas fa-plus"></i> Add Menu Item
        </button>
    </div>

    <!-- Menu Categories -->
    {% if categories %}
    <div class="menu-categories">
        {% for category, items in categories.items() %}
        <div class="category-section mb-4">
            <div class="card">
                <div class="card-header">
                    <h3>{{ category }} ({{ items|length }} items)</h3>
                </div>
                <div class="card-body">
                    <div class="menu-items-grid">
                        {% for item in items %}
                        <div class="menu-item-card">
                            <div class="item-header">
                                <h4>{{ item.name }}</h4>
                                <div class="item-badges">
                                    {% if not item.is_available %}
                                    <span class="badge badge-unavailable">Unavailable</span>
                                    {% endif %}
                                    {% if item.is_special %}
                                    <span class="badge badge-special">Special</span>
                                    {% endif %}
                                    {% if item.is_mostly_ordered %}
                                    <span class="badge badge-popular">Mostly Ordered</span>
                                    {% endif %}
                                    {% if item.is_vegetarian %}
                                    <span class="badge badge-vegetarian">Vegetarian</span>
                                    {% endif %}
                                    {% if item.is_non_veg %}
                                    <span class="badge badge-non-veg">Non-Veg</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <p class="item-description">{{ item.description }}</p>
                            <p class="item-price">${{ "%.2f"|format(item.price) }}</p>
                            
                            <div class="item-stats">
                                <span class="order-count">
                                    <i class="fas fa-chart-bar"></i>
                                    {{ item.order_count }} orders
                                </span>
                            </div>
                            
                            <div class="item-actions">
                                <button class="btn btn-small btn-outline edit-item-btn" 
                                        data-item-id="{{ item.id }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-small btn-outline toggle-availability-btn" 
                                        data-item-id="{{ item.id }}"
                                        data-available="{{ item.is_available }}">
                                    <i class="fas fa-eye{% if not item.is_available %}-slash{% endif %}"></i>
                                    {{ 'Hide' if item.is_available else 'Show' }}
                                </button>
                                <button class="btn btn-small btn-outline delete-item-btn" 
                                        data-item-id="{{ item.id }}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-menu text-center" style="padding: 4rem 0;">
        <i class="fas fa-utensils" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
        <h3>No menu items yet</h3>
        <p class="text-secondary">Start building your menu by adding your first item</p>
        <button class="btn btn-primary" onclick="showAddItemModal()">
            <i class="fas fa-plus"></i> Add First Item
        </button>
    </div>
    {% endif %}
    
    {% else %}
    <div class="no-restaurant text-center" style="padding: 4rem 0;">
        <i class="fas fa-store" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
        <h3>Select a restaurant to manage its menu</h3>
        <p class="text-secondary">Choose from the dropdown above to get started</p>
    </div>
    {% endif %}
</div>

<!-- Add/Edit Item Modal -->
<div id="itemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Menu Item</h2>
            <span class="close" onclick="ModalManager.hide('itemModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="itemForm">
                <div class="form-group">
                    <label for="itemName" class="form-label">Name *</label>
                    <input type="text" id="itemName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="itemDescription" class="form-label">Description</label>
                    <textarea id="itemDescription" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1; margin-right: 1rem;">
                        <label for="itemPrice" class="form-label">Price *</label>
                        <input type="number" id="itemPrice" class="form-control" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Main Category</label>
                        <select id="itemCategory" class="form-control" required onchange="updateSubcategories()">
                            <option value="">Select Category</option>
                            <option value="Food">Food</option>
                            <option value="Beverage">Beverage</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="foodTypeGroup" style="display: none;">
                    <label class="form-label">Food Type</label>
                    <select id="itemFoodType" class="form-control">
                        <option value="">Select Food Type</option>
                        <option value="Appetizer">Appetizer</option>
                        <option value="Main Course">Main Course</option>
                        <option value="Dessert">Dessert</option>
                        <option value="Side Dish">Side Dish</option>
                        <option value="Snack">Snack</option>
                    </select>
                </div>
                
                <div class="form-group" id="beverageTypeGroup" style="display: none;">
                    <label class="form-label">Beverage Type</label>
                    <select id="itemSubcategory" class="form-control">
                        <option value="">Select Beverage Type</option>
                        <option value="Non-Alcoholic">Non-Alcoholic</option>
                        <option value="Alcoholic">Alcoholic</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="isVegetarian">
                            <span>Vegetarian</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="isVegan">
                            <span>Vegan</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="isGlutenFree">
                            <span>Gluten Free</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="isNonVeg">
                            <span>Non-Vegetarian</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="isSpecial">
                            <span>Today's Special</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="isAvailable" checked>
                            <span>Available</span>
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="ModalManager.hide('itemModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveMenuItem()">Save Item</button>
        </div>
    </div>
</div>

<style>
    .menu-items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }
    
    .menu-item-card {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1rem;
        background: white;
        transition: all 0.3s ease;
    }
    
    .menu-item-card:hover {
        box-shadow: var(--shadow-light);
    }
    
    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    
    .item-header h4 {
        margin: 0;
        flex: 1;
    }
    
    .item-badges {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        align-items: flex-end;
    }
    
    .badge-unavailable {
        background: #f8d7da;
        color: #721c24;
    }
    
    .item-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }
    
    .item-price {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    
    .item-stats {
        font-size: 0.8rem;
        color: var(--text-light);
        margin-bottom: 1rem;
    }
    
    .item-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .form-row {
        display: flex;
        gap: 1rem;
    }
    
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.5rem;
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .checkbox-label input[type="checkbox"] {
        margin: 0;
    }
    
    @media (max-width: 768px) {
        .menu-items-grid {
            grid-template-columns: 1fr;
        }
        
        .item-header {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .item-badges {
            flex-direction: row;
            align-items: flex-start;
        }
        
        .item-actions {
            flex-direction: column;
        }
        
        .form-row {
            flex-direction: column;
            gap: 0;
        }
        
        .form-row .form-group {
            margin-right: 0 !important;
        }
    }
</style>

<!-- Restaurant data for JavaScript -->
<script type="application/json" id="restaurant-data">
{% if restaurant %}
{"id": {{ restaurant.id }}}
{% else %}
null
{% endif %}
</script>

<script>
    // Parse restaurant data from JSON script tag
    const restaurantDataScript = document.getElementById('restaurant-data');
    window.restaurantData = restaurantDataScript ? JSON.parse(restaurantDataScript.textContent) : null;
    
    let currentItemId = null;
    let currentRestaurantId = null;
    
    // Safely get restaurant data
    try {
        const restaurantDataElement = document.getElementById('restaurant-data');
        const restaurantData = JSON.parse(restaurantDataElement.textContent);
        currentRestaurantId = restaurantData ? restaurantData.id : null;
    } catch (e) {
        console.warn('Could not parse restaurant data:', e);
        currentRestaurantId = null;
    }
    
    function changeRestaurant() {
        const select = document.getElementById('restaurantSelect');
        const restaurantId = select.value;
        
        if (restaurantId) {
            window.location.href = `{{ url_for('restaurant_menu_management') }}?restaurant_id=${restaurantId}`;
        } else {
            window.location.href = `{{ url_for('restaurant_menu_management') }}`;
        }
    }
    
    function showAddItemModal() {
        if (!currentRestaurantId) {
            showToast('Please select a restaurant first', 'warning');
            return;
        }
        
        currentItemId = null;
        document.getElementById('modalTitle').textContent = 'Add Menu Item';
        document.getElementById('itemForm').reset();
        document.getElementById('isAvailable').checked = true;
        ModalManager.show('itemModal');
    }
    
    function showEditItemModal(itemId) {
        currentItemId = itemId;
        document.getElementById('modalTitle').textContent = 'Edit Menu Item';
        
        // Find the item card and extract data
        const itemCard = document.querySelector(`[data-item-id="${itemId}"]`).closest('.menu-item-card');
        const name = itemCard.querySelector('h4').textContent;
        const description = itemCard.querySelector('.item-description').textContent;
        const price = itemCard.querySelector('.item-price').textContent.replace('$', '');
        
        // Fill form with current values
        document.getElementById('itemName').value = name;
        document.getElementById('itemDescription').value = description;
        document.getElementById('itemPrice').value = price;
        
        // Extract category from the section
        const categorySection = itemCard.closest('.category-section');
        const category = categorySection.querySelector('h3').textContent.split(' (')[0];
        document.getElementById('itemCategory').value = category;
        
        // Set checkboxes based on badges
        const badges = itemCard.querySelectorAll('.badge');
        document.getElementById('isVegetarian').checked = Array.from(badges).some(b => b.textContent === 'Vegetarian');
        document.getElementById('isNonVeg').checked = Array.from(badges).some(b => b.textContent === 'Non-Veg');
        document.getElementById('isSpecial').checked = Array.from(badges).some(b => b.textContent === 'Special');
        document.getElementById('isAvailable').checked = !Array.from(badges).some(b => b.textContent === 'Unavailable');
        
        ModalManager.show('itemModal');
    }
    
    function updateSubcategories() {
        const category = document.getElementById('itemCategory').value;
        const foodTypeGroup = document.getElementById('foodTypeGroup');
        const beverageTypeGroup = document.getElementById('beverageTypeGroup');
        
        if (category === 'Food') {
            foodTypeGroup.style.display = 'block';
            beverageTypeGroup.style.display = 'none';
            document.getElementById('itemSubcategory').value = '';
        } else if (category === 'Beverage') {
            foodTypeGroup.style.display = 'none';
            beverageTypeGroup.style.display = 'block';
            document.getElementById('itemFoodType').value = '';
        } else {
            foodTypeGroup.style.display = 'none';
            beverageTypeGroup.style.display = 'none';
            document.getElementById('itemFoodType').value = '';
            document.getElementById('itemSubcategory').value = '';
        }
    }

    function saveMenuItem() {
        const itemId = document.getElementById('itemId').value;
        const name = document.getElementById('itemName').value;
        const description = document.getElementById('itemDescription').value;
        const price = document.getElementById('itemPrice').value;
        const category = document.getElementById('itemCategory').value;
        const subcategory = document.getElementById('itemSubcategory').value;
        const foodType = document.getElementById('itemFoodType').value;
        const imageUrl = document.getElementById('itemImageUrl').value;
        const isVegetarian = document.getElementById('isVegetarian').checked;
        const isVegan = document.getElementById('isVegan').checked;
        const isGlutenFree = document.getElementById('isGlutenFree').checked;
        const isNonVeg = document.getElementById('isNonVeg').checked;
        const isSpecial = document.getElementById('isSpecial').checked;
        const isAvailable = document.getElementById('isAvailable').checked;

        if (!name || !price || !category) {
            alert('Please fill in all required fields');
            return;
        }

        const data = {
            name: name,
            description: description,
            price: parseFloat(price),
            category: category,
            subcategory: subcategory,
            food_type: foodType,
            image_url: imageUrl,
            is_vegetarian: isVegetarian,
            is_vegan: isVegan,
            is_gluten_free: isGlutenFree,
            is_non_veg: isNonVeg,
            is_special: isSpecial,
            is_available: isAvailable,
            restaurant_id: window.restaurantData ? window.restaurantData.id : null
        };

        const url = itemId ? '/api/menu/update' : '/api/menu-item/add';
        if (itemId) {
            data.item_id = parseInt(itemId);
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Menu item saved successfully!');
                closeModal();
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the menu item');
        });
    }
    
    // Event handlers
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-item-btn')) {
            const itemId = e.target.dataset.itemId;
            showEditItemModal(itemId);
        }
        
        if (e.target.classList.contains('delete-item-btn')) {
            const itemId = e.target.dataset.itemId;
            deleteMenuItem(itemId);
        }
        
        if (e.target.classList.contains('toggle-availability-btn')) {
            const itemId = e.target.dataset.itemId;
            const isAvailable = e.target.dataset.available === 'True';
            toggleItemAvailability(itemId, !isAvailable);
        }
    });
    
    async function deleteMenuItem(itemId) {
        if (!confirm('Are you sure you want to delete this menu item?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/menu/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ item_id: itemId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            console.error('Error deleting menu item:', error);
            showToast('Failed to delete menu item', 'error');
        }
    }
    
    async function toggleItemAvailability(itemId, isAvailable) {
        try {
            const response = await fetch('/api/menu/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    item_id: itemId,
                    is_available: isAvailable
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            console.error('Error updating item availability:', error);
            showToast('Failed to update item availability', 'error');
        }
    }
</script>
{% endblock %}
